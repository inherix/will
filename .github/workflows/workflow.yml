name: will-app
on:
  push:
    branches:
      - main
  workflow_call:

jobs:
  build:
    runs-on:
      ubuntu-latest
    outputs:
      image: ${{ steps.dockerId.outputs.image-version }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          repository: inherix/will
          ref: main
      - name: set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: 'temurin'
          cache: gradle
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      - name: Build with Gradle
        run: ./gradlew build
      - name: Build docker
        id: dockerId
        run: |
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')
          BUILD=${{github.run_number}}
          IMAGE_VERSION="${YEAR}.${MONTH}.${BUILD}"
          echo "image-version=${IMAGE_VERSION}" >> $GITHUB_OUTPUT
      - name: AWS configure
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: login into ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build Docker image
        run: docker build -t inherix-container-registry:${{steps.dockerId.outputs.image-version}} .
      - name: tag image to ECR
        run: docker tag inherix-container-registry:${{steps.dockerId.outputs.image-version}} ${{vars.ECR_REPO}}:${{steps.dockerId.outputs.image-version}}
      - name: push image to ECR
        run: docker push ${{vars.ECR_REPO}}:${{steps.dockerId.outputs.image-version}}
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: AWS configure
        uses: aws-actions/configure-aws-credentials@v2
        with:
         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         aws-region: ${{ vars.AWS_REGION }}
      - name: Configure EKS
        run: aws eks update-kubeconfig --region ${{vars.AWS_REGION}} --name inherix-dev
      - name: Apply Kubernetes manifests
        run: kubectl apply -f Spring.yaml
      - name: apply to EKS
        run: kubectl set image deployment/will-app-deployment will-app-container=${{ vars.ECR_REPO }}:${{ needs.build.outputs.image }}
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/will-app-deployment


















